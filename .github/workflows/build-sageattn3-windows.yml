name: Build SageAttention3 Wheels (Windows)

on:
  workflow_call:
    inputs:
      build_profile:
        description: 'Build profile to use'
        required: true
        default: 'stable'
        type: string
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'Build profile to use'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable      # All builds

jobs:
  # Job 1: Validate/Configure
  configure:
    runs-on: windows-latest
    outputs:
      build_profile: ${{ steps.set-profile.outputs.profile }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set build profile
        id: set-profile
        shell: bash
        run: |
          echo "profile=${{ inputs.build_profile }}" >> $GITHUB_OUTPUT

  # Job 2: Generate build matrix dynamically
  generate-matrix:
    needs: configure
    runs-on: windows-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate build matrix
        id: generate
        shell: bash
        run: |
          profile="${{ needs.configure.outputs.build_profile }}"

          # Define all possible build configurations
          # Format: python_version|pytorch_version|cuda_version|display_name
          declare -a all_builds=(
            "3.12|2.9.0|12.8.0|Sage3 + PyTorch 2.9.0 + CUDA 12.8 + Python 3.12"
            "3.12|2.9.0|12.9.0|Sage3 + PyTorch 2.9.0 + CUDA 12.9 + Python 3.12"
            "3.12|2.9.0|13.0.0|Sage3 + PyTorch 2.9.0 + CUDA 13.0 + Python 3.12"
            "3.12|2.9.0|13.1.0|Sage3 + PyTorch 2.9.0 + CUDA 13.1 + Python 3.12"
          )

          # Filter builds
          declare -a selected_builds=("${all_builds[@]}")

          # Convert to JSON matrix format
          matrix_json="["
          first=true
          for build in "${selected_builds[@]}"; do
            IFS='|' read -r python pytorch cuda display <<< "$build"
            if [ "$first" = true ]; then
              first=false
            else
              matrix_json+=","
            fi
            matrix_json+="{\"python\":\"$python\",\"pytorch\":\"$pytorch\",\"cuda\":\"$cuda\",\"display\":\"$display\"}"
          done
          matrix_json+="]"

          echo "matrix={\"include\":$matrix_json}" >> $GITHUB_OUTPUT
          echo "Build count: ${#selected_builds[@]}"
          echo "$matrix_json" | jq .

  # Job 3: Build wheels on Windows
  build-wheels:
    name: Build ${{ matrix.display }}
    needs: [configure, generate-matrix]
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive # REQUIRED for cutlass

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: ${{ matrix.cuda }}
          log-file-suffix: "log-windows-sage3-py${{ matrix.python }}-torch${{ matrix.pytorch }}.txt"

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure git for line endings
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Upgrade pip and install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel packaging

      - name: Install PyTorch
        shell: bash
        run: |
          cuda_version="${{ matrix.cuda }}"
          pytorch_version="${{ matrix.pytorch }}"

          if [[ "$cuda_version" =~ ^12\.[89] ]] || [[ "$cuda_version" =~ ^13\. ]]; then
             index_url="https://download.pytorch.org/whl/cu126"
          else
             index_url="https://download.pytorch.org/whl/cu121"
          fi
          
          pip install torch==$pytorch_version torchvision --index-url "$index_url"

      - name: Install build dependencies
        run: |
          pip install numpy packaging pybind11

      - name: Build wheel (Sage3)
        working-directory: ./sageattention3_blackwell
        shell: powershell
        run: |
          # Extract version components for build tags
          $pytorch = "${{ matrix.pytorch }}"
          $cuda = "${{ matrix.cuda }}"
          
          # Pattern: 12.8.0 -> 12.8 -> 128
          $cuda_parts = $cuda.Split('.')
          $cuda_tag = $cuda_parts[0] + $cuda_parts[1]
          
          $env:SAGEATTENTION_WHEEL_VERSION_SUFFIX = "+cu" + $cuda_tag + "torch" + $pytorch
          $env:TORCH_CUDA_ARCH_LIST = "10.0;12.0"
          $env:DISTUTILS_USE_SDK = "1"
          $env:MAX_JOBS = "1"
          
          python setup.py bdist_wheel

      - name: Verify wheel naming
        working-directory: ./sageattention3_blackwell
        shell: bash
        run: |
          echo "=== Built wheels ==="
          ls -lh dist/

          for wheel in dist/*.whl; do
            filename=$(basename "$wheel")
            echo "Checking wheel: $filename"
            
            # Pattern: sageattn3-1.0.0+cu128torch2.9.0-cp312-cp312-win_amd64.whl
            if [[ ! $filename =~ ^sageattn3-1\.0\.0\+cu[0-9]+torch[0-9]+\.[0-9]+\.[0-9]+-cp[0-9]+-cp[0-9]+-win_amd64\.whl$ ]]; then
              echo "❌ Wheel name warning: $filename"
            else
              echo "✅ Wheel name looks correct: $filename"
            fi
          done

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheel-windows-sage3-py${{ matrix.python }}-torch${{ matrix.pytorch }}-cuda${{ matrix.cuda }}
          path: ./sageattention3_blackwell/dist/*.whl
          retention-days: 7
          compression-level: 0

      - name: Test wheel installation
        working-directory: ./sageattention3_blackwell
        shell: bash
        run: |
          cuda_version="${{ matrix.cuda }}"
          if [[ "$cuda_version" =~ ^12\.[89] ]] || [[ "$cuda_version" =~ ^13\. ]]; then
             index_url="https://download.pytorch.org/whl/cu126"
          else
             index_url="https://download.pytorch.org/whl/cu121"
          fi
          
          wheel=$(ls dist/*.whl | head -n 1)
          
          echo "Installing $wheel with index $index_url"
          pip install "$wheel" --index-url "$index_url"
