name: Build SageAttention Wheels (Linux)

on:
  workflow_call:
    inputs:
      build_profile:
        description: 'Build profile to use'
        required: true
        default: 'stable'
        type: string
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'Build profile to use'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable      # Both PyTorch versions (2 wheels)
          - sage2-all   # Same as stable (2 wheels)

jobs:
  # Job 1: Generate build matrix
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: generate
        uses: ./.github/actions/generate-matrix
        with:
          build_profile: ${{ inputs.build_profile }}
          os: 'linux'
          project: 'sage2'

  # Job 2: Build wheels on Linux (Native)
  build-wheels:
    name: Build ${{ matrix.display }}
    needs: [generate-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Setup CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: ${{ matrix.cuda }}
          use-github-cache: false
          log-file-suffix: "log-linux-py${{ matrix.python }}-torch${{ matrix.pytorch }}-cuda${{ matrix.cuda }}.txt"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Upgrade pip and install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel packaging

      - name: Install PyTorch ${{ matrix.pytorch }}
        run: |
          cuda_version="${{ matrix.cuda }}"
          pytorch_version="${{ matrix.pytorch }}"
          
          echo "DEBUG: Installing PyTorch. CUDA=$cuda_version, TORCH=$pytorch_version"
          
          # Construct index URL
          if [[ "$cuda_version" == "12.4"* ]]; then
            index_url="https://download.pytorch.org/whl/cu124"
          elif [[ "$cuda_version" =~ ^12\.[89] ]] || [[ "$cuda_version" =~ ^13\. ]]; then
             # For CUDA 12.8+, 12.9, 13.x we use cu126 for now as it's the latest stable PyTorch ABI
             index_url="https://download.pytorch.org/whl/cu126"
          else
             # Fallback for old/other versions
             index_url="https://download.pytorch.org/whl/cu118"
          fi
          
          echo "DEBUG: Using index URL: $index_url"
          echo "DEBUG: Command: pip install torch==$pytorch_version torchvision --index-url $index_url"
          
          pip install torch==$pytorch_version torchvision --index-url "$index_url"
          
          echo "DEBUG: Installed packages:"
          pip list | grep torch

      - name: Install build dependencies
        run: |
          pip install numpy packaging pybind11

      - name: Update pyproject.toml with PyTorch version
        run: python update_pyproject.py

      - name: Set build version suffix
        run: |
          # Pattern: 2.7.0 -> 270
          torch_tag=$(echo "${{ matrix.pytorch }}" | tr -d '.')
          
          # Pattern: 12.8.0 -> 12.8 -> 128
          cuda_tag=$(echo "${{ matrix.cuda }}" | cut -d. -f1,2 | tr -d '.')
          
          echo "SAGEATTENTION_BUILD_TAG=${torch_tag}.${cuda_tag}" >> $GITHUB_ENV
      
      - name: Build wheel (${{ matrix.display }})
        run: |
          python setup.py bdist_wheel --build-number "${{ env.SAGEATTENTION_BUILD_TAG }}"
        env:
          TORCH_VERSION: ${{ matrix.pytorch }}
          CUDA_VERSION: ${{ matrix.cuda }}
          TORCH_CUDA_ARCH_LIST: ${{ matrix.arch_list }}
          MAX_JOBS: "1"

      - name: Verify wheel naming
        shell: bash
        run: |
          echo "=== Built wheels ==="
          ls -lh dist/

          # Verify PEP 427 compliant naming
          for wheel in dist/*.whl; do
            filename=$(basename "$wheel")
            # Verify PEP 427 compliant naming
            if [[ ! $filename =~ ^sageattention-[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+-cp[0-9]+-cp[0-9]+-linux_x86_64\.whl$ ]]; then
              echo "❌ Wheel name does not match expected pattern: $filename"
              exit 1
            fi

            # Extract version info from filename
            if [[ $filename =~ sageattention-([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)\.([0-9]+)-cp([0-9]+) ]]; then
              sage_version="${BASH_REMATCH[1]}"
              torch_tag="${BASH_REMATCH[2]}"
              cuda_tag="${BASH_REMATCH[3]}"
              python_version="${BASH_REMATCH[4]}"

              echo "  ✅ SageAttention version: $sage_version"
              echo "  ✅ Build Tag: $torch_tag.$cuda_tag"
              echo "  ✅ Python version: $python_version (3.$python_version)"
            fi
          done

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheel-linux-py${{ matrix.python }}-torch${{ matrix.pytorch }}-cuda${{ matrix.cuda }}
          path: ./dist/*.whl
          retention-days: 7
          compression-level: 0

      - name: Test wheel installation
        run: |
          wheel=$(ls dist/*.whl | head -n 1)
          
          # Re-determine index URL to avoid pip downgrading torch to PyPI version
          cuda_version="${{ matrix.cuda }}"
          if [[ "$cuda_version" =~ ^12\.[89] ]] || [[ "$cuda_version" =~ ^13\. ]]; then
             index_url="https://download.pytorch.org/whl/cu126"
          else
             index_url="https://download.pytorch.org/whl/cu118"
          fi
          
          echo "Installing wheel with index: $index_url"
          pip install "$wheel" --index-url "$index_url"
          
          # Change to dist directory to avoid importing sageattention from source
          cd dist

